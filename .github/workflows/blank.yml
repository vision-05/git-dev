name: Modify File Once (Fork-Safe)

on:
  push:

# This requests write permissions for the GITHUB_TOKEN.
# The repository setting must also be enabled to grant this request.
permissions:
  contents: write

jobs:
  edit-once-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files
        id: changed_files
        uses: tj-actions/changed-files@v44

      - name: Modify File If Not Already Modified
        # This step only runs if at least one file was changed
        if: steps.changed_files.outputs.all_changed_files_count > 0
        run: |
          FIRST_FILE=$(echo "${{ steps.changed_files.outputs.all_changed_files }}" | awk '{print $1}')
          SIGNATURE=""

          # Check if the file ALREADY contains the signature using grep
          # The '-q' flag makes grep quiet, it just returns an exit code
          if ! grep -q "$SIGNATURE" "$FIRST_FILE"; then
            echo "✅ Signature not found. Modifying file: $FIRST_FILE"
            
            # Append a blank line for spacing, then the signature
            echo "" >> "$FIRST_FILE"
            echo "$SIGNATURE" >> "$FIRST_FILE"

            # Configure git, commit, and push the change
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add "$FIRST_FILE"
            git commit -m "chore: Add modification signature to $FIRST_FILE [skip ci]"
            git push
          else
            echo "☑️ Signature already found in $FIRST_FILE. No action needed."
          fi
          
          # Add, commit, and push the changes
          git add "$FIRST_FILE"
          git commit -m "chore: Auto-modify file via Action [skip ci]"
          git push
